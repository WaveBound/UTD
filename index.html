<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Universal TD Optimizer</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>

    <header>
        <h1>Meta Optimizer</h1>
    </header>

    <!-- STICKY TOOLBAR -->
    <div class="sticky-toolbar-container">
        
        <!-- Navigation -->
        <div class="nav-bar">
            <button class="nav-btn active" onclick="switchPage('db')">Unit Database</button>
            <button class="nav-btn" onclick="switchPage('guides')">Build Guides</button>
            <button id="selectAllBtn" class="nav-btn" onclick="selectAllUnits()">Select All</button>
            <button id="compareBtn" class="nav-btn" onclick="openComparison()">Compare (<span id="compareCount">0</span>)</button>
            <button class="nav-btn" onclick="openPatchNotes()">Patch Notes</button>
        </div>

        <!-- 1. DATABASE TOOLBAR -->
        <div id="dbInjector" class="injector-panel">
            <button class="nav-btn add-btn" onclick="openCustomPairModal()">+ Add Custom Pair</button>
            
            <label id="hypoToggle" class="nav-toggle-label" title="Current: Relic Stats for DoT% are ignored (Bugged). Check to apply fixes.">
                <input type="checkbox" id="globalHypothetical" onchange="toggleHypothetical(this)">
                <span id="hypoLabel">Bugged Relics</span>
            </label>

            <label id="headPieceToggle" class="nav-toggle-label is-checked" title="Auto-equips the best Unique Head Piece">
                <input type="checkbox" id="globalHeadPiece" onchange="toggleHeadPiece(this)" checked>
                <span>+ Head Relic</span>
            </label>

            <label id="subStatsToggle" class="nav-toggle-label is-checked" title="Adds Perfect Sub-Stats to Calculations">
                <input type="checkbox" id="globalSubStats" onchange="toggleSubStats(this)" checked>
                <span>+ Sub Stats</span>
            </label>
        </div>

        <!-- 2. GUIDES TOOLBAR -->
        <div id="guidesToolbar" class="injector-panel" style="display:none;">
            <select id="guideUnitSelect" style="display:none;"><option value="all">All Units</option></select>
            <select id="guideTraitSelect" style="display:none;"><option value="auto">Auto</option></select>

            <button class="nav-btn" style="border:1px solid var(--accent-start); color:var(--accent-start); margin-right:15px;" onclick="openGuideConfig()">
            Configure View
            </button>

            <label id="guideHypoToggleWrapper" class="nav-toggle-label">
                <input type="checkbox" id="guideHypoToggle" onchange="toggleHypothetical(this)">
                <span id="guideHypoLabel">Bugged Relics</span>
            </label>

            <label class="nav-toggle-label is-checked" title="Auto-equips the best Unique Head Piece">
                <input type="checkbox" id="guideHeadPiece" onchange="toggleGuideHeadPiece(this)" checked>
                <span>+ Head Relic</span>
            </label>

            <label class="nav-toggle-label is-checked">
                <input type="checkbox" id="guideSubStats" onchange="toggleGuideSubStats(this)" checked>
                <span>+ Sub Stats</span>
            </label>
        </div>
    </div>

    <!-- DATABASE PAGE -->
    <div id="dbPage" class="page active db-grid">
        <!-- Units injected via JS -->
    </div>

    <!-- GUIDES PAGE -->
    <div id="guidesPage" class="page">
        <div class="guide-container">
            <div id="activeGuideSelection" style="text-align:center; margin-bottom:15px; font-size:0.9rem; color:#aaa;">
                Showing: <b style="color:#fff;" id="dispGuideUnit">All Units</b> with <b style="color:var(--accent-end);" id="dispGuideTrait">Auto Trait</b>
            </div>

            <div id="guideWarning" class="guide-warning">
                ⚠️ CURRENT BUG: Relic Stats for <b>DoT%</b> are currently ignored by the game. <br>
                Crit Rate% and Crit Dmg% are working effectively.
            </div>

            <div id="guideList" class="guide-grid">
                <!-- Cards injected via JS -->
            </div>
        </div>
    </div>

    <!-- MODALS -->

    <!-- Trait Guide Modal -->
    <div id="traitGuideModal" class="modal-overlay" onclick="closeTraitGuide()">
        <div class="modal-content" style="max-width: 500px;" onclick="event.stopPropagation()">
            <div class="modal-header-fixed">
                <h2 style="margin:0; font-size: 1.2rem; text-transform:uppercase;">Recommended Traits</h2>
            </div>
            <div id="traitGuideContent" class="modal-scroll-area"></div>
            <div class="modal-footer-fixed"><button class="action-btn" onclick="closeTraitGuide()">Close</button></div>
        </div>
    </div>

    <!-- Guide Config -->
    <div id="guideConfigModal" class="modal-overlay" onclick="closeGuideConfig()">
        <div class="modal-content" style="max-width: 800px;" onclick="event.stopPropagation()">
            <div class="modal-header-fixed">
                <h2 style="margin:0; font-size: 1.2rem; text-transform:uppercase;">Guide Configuration</h2>
            </div>
            <div class="modal-scroll-area">
                <div class="config-section">
                    <div class="config-header">1. Select Unit</div>
                    <div class="config-grid" id="guideConfigUnitGrid"></div>
                </div>
                <div class="config-section" style="margin-top:20px;">
                    <div class="config-header">2. Select Trait</div>
                    <div class="config-chips" id="guideConfigTraitList"></div>
                </div>
            </div>
            <div class="modal-footer-fixed" style="display:flex; gap:10px;">
                <button class="action-btn secondary" onclick="closeGuideConfig()">Cancel</button>
                <button class="action-btn" onclick="applyGuideConfig()">Apply Settings</button>
            </div>
        </div>
    </div>

    <!-- Custom Pair -->
    <div id="customPairModal" class="modal-overlay" onclick="closeCustomPairModal()">
        <div class="modal-content" style="max-width: 800px;" onclick="event.stopPropagation()">
            <div class="modal-header-fixed" style="background: linear-gradient(to right, #06b6d4, #0f1014); border-bottom: 1px solid #06b6d4;">
                <h2 style="margin:0; font-size: 1.2rem; text-transform:uppercase; color:#fff;">Create Custom Pair</h2>
            </div>
            <div class="modal-scroll-area">
                <div class="config-section">
                    <div class="config-header" style="color:#06b6d4;">1. Assign To Unit</div>
                    <div class="config-grid" id="cpUnitGrid"></div>
                </div>
                <div class="config-section" style="margin-top:20px;">
                    <div class="config-header" style="color:#06b6d4;">2. Select First Trait</div>
                    <div class="config-chips" id="cpTrait1List"></div>
                </div>
                <div class="config-section" style="margin-top:20px;">
                    <div class="config-header" style="color:#06b6d4;">3. Select Second Trait</div>
                    <div class="config-chips" id="cpTrait2List"></div>
                </div>
                <div style="margin-top:25px; background:rgba(6, 182, 212, 0.1); padding:10px; border-radius:8px; border:1px solid #06b6d4; text-align:center;">
                    <span style="color:#aaa; font-size:0.8rem; text-transform:uppercase;">Creating Combination:</span><br>
                    <b style="color:#fff; font-size:1.1rem;" id="cpPreviewText">Loading...</b>
                </div>
            </div>
            <div class="modal-footer-fixed" style="display:flex; gap:10px;">
                <button class="action-btn secondary" onclick="closeCustomPairModal()">Cancel</button>
                <button class="action-btn" style="background:var(--custom); color:#000;" onclick="confirmAddCustomPair()">Create Pair</button>
            </div>
        </div>
    </div>

    <!-- Math Modal -->
    <div id="mathModal" class="modal-overlay" onclick="closeMath()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header-fixed">
                <h2 style="margin:0; color:var(--accent-start); font-size: 1.5rem; text-transform:uppercase;">DPS Breakdown</h2>
            </div>
            <div id="mathContent" class="modal-scroll-area"></div>
            <div class="modal-footer-fixed"><button class="action-btn" onclick="closeMath()">Close</button></div>
        </div>
    </div>

    <!-- Sub Stat Priority Modal -->
    <div id="subPriorityModal" class="modal-overlay" onclick="closeSubPriority()">
        <div class="modal-content" style="max-width: 500px;" onclick="event.stopPropagation()">
            <div class="modal-header-fixed">
                <h2 style="margin:0; font-size: 1.2rem; text-transform:uppercase;">Sub-Stat Priority</h2>
            </div>
            <div style="background:rgba(255,255,255,0.05); padding:10px 20px; font-size:0.8rem; color:#aaa; border-bottom:1px solid #333;">
                Comparing performance if you roll <strong>Perfect Stats</strong> of a specific type.
            </div>
            <div id="subPriorityContent" class="modal-scroll-area"></div>
            <div class="modal-footer-fixed"><button class="action-btn" onclick="closeSubPriority()">Close</button></div>
        </div>
    </div>

    <!-- Compare Modal -->
    <div id="compareModal" class="modal-overlay" onclick="closeCompare()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header-fixed">
                <h2 style="margin:0; font-size: 1.5rem; text-transform:uppercase;">Meta Comparison</h2>
            </div>
            <div id="compareContent" class="modal-scroll-area"></div>
            <div class="modal-footer-fixed"><button class="action-btn secondary" onclick="closeCompare()">Close</button></div>
        </div>
    </div>

    <!-- Patch Notes -->
    <div id="patchModal" class="modal-overlay" onclick="closePatchNotes()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header-fixed"><h2 style="margin:0; font-size: 1.5rem; text-transform:uppercase;">Patch Notes</h2></div>
            <div class="modal-scroll-area" id="patchNotesContainer"></div>
            <div class="modal-footer-fixed"><button class="action-btn" onclick="closePatchNotes()">Close</button></div>
        </div>
    </div>

    <!-- Custom Calculator Modal (Reworked UI) -->
    <div id="calcModal" class="modal-overlay" onclick="closeCalc()">
        <div class="modal-content" onclick="event.stopPropagation()">
            
            <!-- 1. Header & Global Config -->
            <div class="calc-unit-header">
                <!-- Image injected via JS -->
                <img id="calcUnitImg" src="" class="calc-avatar"> 
                
                <div class="calc-unit-details">
                    <h2 id="calcUnitName" class="calc-unit-name">Unit Name</h2>
                    <span id="calcUnitRole" class="calc-unit-role">Role</span>
                </div>

                <div class="calc-global-controls">
                    <div class="c-control-group">
                        <label>Dmg Pts</label>
                        <input type="number" id="calcDmgPoints" class="c-input" value="0" min="0" max="100">
                    </div>
                    <div class="c-control-group">
                        <label>Spa Pts</label>
                        <input type="number" id="calcSpaPoints" class="c-input" value="0" min="0" max="100">
                    </div>
                    
                    <div class="c-control-group" style="flex-grow:1;">
                        <label>Relic Set</label>
                        <select id="calcSet" class="c-input" style="width:100%"></select>
                    </div>

                    <div class="c-control-group" style="flex-grow:1;">
                        <label>Trait</label>
                        <select id="calcTrait" class="c-input" style="width:100%"></select>
                    </div>
                </div>
            </div>

            <div class="modal-scroll-area" style="padding:0; background:#050505;">
                
                <!-- 2. Gear Grid (Head, Body, Legs) -->
                <div class="gear-grid-container">
                    
                    <!-- HEAD PIECE -->
                    <div class="gear-card">
                        <div class="gear-header">
                            <span class="gear-title">Head Piece</span>
                            <div style="display:flex; gap:8px; align-items:flex-end; flex:1;">
                                <select id="calcHead" class="gear-main-select" style="border-color:#333; color:#aaa; flex:1;">
                                    <option value="none">None / Standard</option>
                                    <option value="sun_god" style="color:#38bdf8; font-weight:bold;">Sun God (+Range% Dmg)</option>
                                    <option value="ninja" style="color:#fff; font-weight:bold;">Master Ninja (+20% DoT)</option>
                                    <option value="reaper_necklace" style="color:#ef4444;">Reaper Necklace</option>
                                    <option value="shadow_reaper_necklace" style="color:#a855f7;">Shadow Reaper Necklace</option>
                                </select>
                                <select id="calcHeadStars" class="gear-main-select" style="color:var(--gold); font-weight:bold; width:65px; display:none;">
                                    <option value="1">1★</option>
                                    <option value="1.025">2★</option>
                                    <option value="1.05" selected>3★</option>
                                </select>
                            </div>
                        </div>
                        <div class="gear-subs"> <!-- Container -->
                            <div class="sub-input-group"><span class="sub-label sub-dmg">Dmg</span><input type="number" data-stat="dmg" class="sub-val-input" placeholder="0"></div>
                            <div class="sub-input-group"><span class="sub-label sub-spa">Spa</span><input type="number" data-stat="spa" class="sub-val-input" placeholder="0"></div>
                            <div class="sub-input-group"><span class="sub-label sub-range">Rng</span><input type="number" data-stat="range" class="sub-val-input" placeholder="0"></div>
                            <div class="sub-input-group"><span class="sub-label sub-cm">CDmg</span><input type="number" data-stat="cm" class="sub-val-input" placeholder="0"></div>
                            <div class="sub-input-group"><span class="sub-label sub-cf">Crit</span><input type="number" data-stat="cf" class="sub-val-input" placeholder="0"></div>
                            <div class="sub-input-group"><span class="sub-label sub-dot">DoT</span><input type="number" data-stat="dot" class="sub-val-input" placeholder="0"></div>
                        </div>
                    </div>

                    <!-- BODY PIECE -->
                    <div class="gear-card">
                        <div class="gear-header">
                            <span class="gear-title">Body Main Stat</span>
                            <div style="display:flex; gap:8px; align-items:flex-end; flex:1;">
                                <select id="calcBodyMain" class="gear-main-select" style="flex:1;">
                                    <option value="dmg">Damage +60%</option>
                                    <option value="dot">DoT +75%</option>
                                    <option value="cm">Crit Dmg +120%</option>
                                </select>
                                <select id="calcBodyStars" class="gear-main-select" style="color:var(--gold); font-weight:bold; width:65px; display:none;">
                                    <option value="1">1★</option>
                                    <option value="1.025">2★</option>
                                    <option value="1.05" selected>3★</option>
                                </select>
                            </div>
                        </div>
                        <div class="gear-subs">
                            <div class="sub-input-group"><span class="sub-label sub-dmg">Dmg</span><input type="number" data-stat="dmg" class="sub-val-input" placeholder="0"></div>
                            <div class="sub-input-group"><span class="sub-label sub-spa">Spa</span><input type="number" data-stat="spa" class="sub-val-input" placeholder="0"></div>
                            <div class="sub-input-group"><span class="sub-label sub-range">Rng</span><input type="number" data-stat="range" class="sub-val-input" placeholder="0"></div>
                            <div class="sub-input-group"><span class="sub-label sub-cm">CDmg</span><input type="number" data-stat="cm" class="sub-val-input" placeholder="0"></div>
                            <div class="sub-input-group"><span class="sub-label sub-cf">Crit</span><input type="number" data-stat="cf" class="sub-val-input" placeholder="0"></div>
                            <div class="sub-input-group"><span class="sub-label sub-dot">DoT</span><input type="number" data-stat="dot" class="sub-val-input" placeholder="0"></div>
                        </div>
                    </div>

                    <!-- LEGS PIECE -->
                    <div class="gear-card">
                        <div class="gear-header">
                            <span class="gear-title">Legs Main Stat</span>
                            <div style="display:flex; gap:8px; align-items:flex-end; flex:1;">
                                <select id="calcLegsMain" class="gear-main-select" style="flex:1;">
                                    <option value="dmg">Damage +60%</option>
                                    <option value="spa">SPA -22.5%</option>
                                    <option value="cf">Crit Rate +37.5%</option>
                                    <option value="range">Range +30%</option>
                                </select>
                                <select id="calcLegsStars" class="gear-main-select" style="color:var(--gold); font-weight:bold; width:65px; display:none;">
                                    <option value="1">1★</option>
                                    <option value="1.025">2★</option>
                                    <option value="1.05" selected>3★</option>
                                </select>
                            </div>
                        </div>
                        <div class="gear-subs">
                            <div class="sub-input-group"><span class="sub-label sub-dmg">Dmg</span><input type="number" data-stat="dmg" class="sub-val-input" placeholder="0"></div>
                            <div class="sub-input-group"><span class="sub-label sub-spa">Spa</span><input type="number" data-stat="spa" class="sub-val-input" placeholder="0"></div>
                            <div class="sub-input-group"><span class="sub-label sub-range">Rng</span><input type="number" data-stat="range" class="sub-val-input" placeholder="0"></div>
                            <div class="sub-input-group"><span class="sub-label sub-cm">CDmg</span><input type="number" data-stat="cm" class="sub-val-input" placeholder="0"></div>
                            <div class="sub-input-group"><span class="sub-label sub-cf">Crit</span><input type="number" data-stat="cf" class="sub-val-input" placeholder="0"></div>
                            <div class="sub-input-group"><span class="sub-label sub-dot">DoT</span><input type="number" data-stat="dot" class="sub-val-input" placeholder="0"></div>
                        </div>
                    </div>

                </div>

                <!-- Result Area -->
                <div id="calcResultArea" style="display:none; border-top:1px solid #222; background:#0a0a0c; padding:20px;">
                    <div id="calcResultContent"></div>
                </div>

            </div>

            <!-- Footer Actions -->
            <div class="calc-footer-bar">
                <button class="action-btn secondary" onclick="closeCalc()" style="width:auto; padding:10px 25px;">Close</button>
                <button class="action-btn" onclick="runCustomCalc()" style="width:auto; padding:10px 25px; background:linear-gradient(135deg, var(--accent-start), var(--accent-end)); box-shadow:0 0 15px rgba(59, 130, 246, 0.4);">Calculate DPS</button>
            </div>
        </div>
    </div>

    <!-- Data & Math Engines -->
    <script src="data.js"></script>
    <script src="math.js"></script>
    
    <!-- Modular Script Files -->
    <script src="modules/state.js"></script>
    <script src="modules/constants.js"></script>
    <script src="modules/utils.js"></script>
    <script src="modules/ui-helpers.js"></script>
    <script src="modules/calculations.js"></script>
    <script src="modules/rendering.js"></script>
    <script src="modules/modals.js"></script>
    <script src="modules/guides.js"></script>
    <script src="modules/custom-pair.js"></script>
    <script src="modules/calculator.js"></script>
    <script src="modules/math-render.js"></script>
    <script src="modules/sub-priority.js"></script>
    <script src="modules/init.js"></script>
</body>
</html>