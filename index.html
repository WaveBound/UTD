<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Universal TD Optimizer</title>
    
    <!-- CSS IMPORTS -->
    <link rel="stylesheet" href="css/variables.css">
    <link rel="stylesheet" href="css/base.css">
    <link rel="stylesheet" href="css/buttons.css">
    <link rel="stylesheet" href="css/cards.css">
    <link rel="stylesheet" href="css/forms.css">
    <link rel="stylesheet" href="css/modals.css">
    <link rel="stylesheet" href="css/utilities.css">
    <link rel="stylesheet" href="css/logic.css">
    <link rel="stylesheet" href="css/mobile.css">
    <link rel="stylesheet" href="css/inventory.css">
</head>
<body>

    <!-- HEADER & TOOLBAR (Same as before) -->
    <div id="headerTitleSection" class="header-wrapper">
        <div class="header-inner">
            <header id="mainHeader">
                <div id="headerContent">
                    <h1>Meta Optimizer</h1>
                    <div id="creditsContainer" class="credits-badges"></div>
                </div>
            </header>
        </div>
    </div>

    <!-- TOOLBAR SECTION -->
    <div id="sticky-sentinel"></div>
    <div id="headerToolbarSection" class="sticky-toolbar-container">
        <div class="mobile-menu-handle" onclick="toggleMobileMenu()"></div>
        <div class="nav-bar">
            <button class="nav-btn active" onclick="switchPage('db'); toggleMobileMenuIfOpen()">Unit Database</button>
            <button class="nav-btn" onclick="switchPage('guides'); toggleMobileMenuIfOpen()">Build Guides</button>
            <button class="nav-btn" onclick="resetAndOpenInventory(); toggleMobileMenuIfOpen()">Relic Inventory</button>
            <button id="selectAllBtn" class="nav-btn" onclick="selectAllUnits()">Select All</button>
            <button id="compareBtn" class="nav-btn" onclick="openComparison(); toggleMobileMenuIfOpen()">Compare (<span id="compareCount">0</span>)</button>
            <button class="nav-btn" onclick="openPatchNotes(); toggleMobileMenuIfOpen()">Patch Notes</button>
            <button class="nav-btn" onclick="openFeedbackModal(); toggleMobileMenuIfOpen()">Report / Suggest</button>
        </div>

        <div id="dbInjector" class="injector-panel">
            <button class="nav-btn add-btn" onclick="openCustomPairModal(); toggleMobileMenuIfOpen()">+ Add Custom Pair</button>
            <label id="invModeToggle" class="nav-toggle-label" title="Calculate using Inventory">
                <input type="checkbox" id="globalInventoryMode" onchange="toggleInventoryMode(this)">
                <span id="invLabel" class="text-accent-start">Inventory Mode</span>
                <div class="mobile-switch-visual"></div>
            </label>
            <label id="hypoToggle" class="nav-toggle-label">
                <input type="checkbox" id="globalHypothetical" onchange="toggleHypothetical(this)">
                <span id="hypoLabel">Bugged Relics</span>
                <div class="mobile-switch-visual"></div>
            </label>
            <label id="headPieceToggle" class="nav-toggle-label is-checked">
                <input type="checkbox" id="globalHeadPiece" onchange="toggleHeadPiece(this)" checked>
                <span>+ Head Relic</span>
                <div class="mobile-switch-visual"></div>
            </label>
            <label id="subStatsToggle" class="nav-toggle-label is-checked">
                <input type="checkbox" id="globalSubStats" onchange="toggleSubStats(this)" checked>
                <span>+ Sub Stats</span>
                <div class="mobile-switch-visual"></div>
            </label>
        </div>

        <!-- Guides Toolbar -->
        <div id="guidesToolbar" class="injector-panel hidden">
            <select id="guideUnitSelect" class="hidden"><option value="all">All Units</option></select>
            <select id="guideTraitSelect" class="hidden"><option value="auto">Auto</option></select>
            <button class="nav-btn config-view-btn" onclick="openGuideConfig(); toggleMobileMenuIfOpen()">Configure View</button>
            <label class="nav-toggle-label">
                <input type="checkbox" id="guideInventoryMode" onchange="toggleInventoryMode(this)">
                <span class="text-accent-start">Inventory Mode</span>
                <div class="mobile-switch-visual"></div>
            </label>
            <label id="guideHypoToggleWrapper" class="nav-toggle-label">
                <input type="checkbox" id="guideHypoToggle" onchange="toggleHypothetical(this)">
                <span id="guideHypoLabel">Bugged Relics</span>
                <div class="mobile-switch-visual"></div>
            </label>
            <label class="nav-toggle-label is-checked">
                <input type="checkbox" id="guideHeadPiece" onchange="toggleGuideHeadPiece(this)" checked>
                <span>+ Head</span>
                <div class="mobile-switch-visual"></div>
            </label>
            <label class="nav-toggle-label is-checked">
                <input type="checkbox" id="guideSubStats" onchange="toggleGuideSubStats(this)" checked>
                <span>+ Subs</span>
                <div class="mobile-switch-visual"></div>
            </label>
        </div>

        <div id="inventoryToolbar" class="injector-panel hidden">
            <button id="openAddRelicBtn" class="nav-btn add-btn" onclick="toggleMobileMenuIfOpen()">+ Add Relic</button>
        </div>
        <div class="header-toggle-strip" onclick="toggleHeader()"><button id="headerToggleBtn" class="header-toggle-btn">▲</button></div>
    </div>

    <button id="mobileMenuFab" class="mobile-fab" onclick="toggleMobileMenu()"><span>☰</span></button>

    <!-- PAGES -->
    <div id="dbPage" class="page active db-grid"></div>
    <div id="inventoryPage" class="page"><div id="relicGrid" class="inventory-grid"></div></div>
    <div id="guidesPage" class="page">
        <div class="guide-container">
            <div id="activeGuideSelection" class="text-center mb-2 text-sm-dim">Showing: <b class="color-white" id="dispGuideUnit">All</b> with <b class="color-accent" id="dispGuideTrait">Auto</b></div>
            <div id="guideWarning" class="guide-warning">⚠️ CURRENT BUG: Relic Stats for <b>DoT%</b> are currently ignored.</div>
            <div id="guideList" class="guide-grid"></div>
        </div>
    </div>

    <!-- ================= MODALS ================= -->

    <!-- 1. THE UNIVERSAL MODAL (Replaces Math, Patch, Compare, SubPrio, Guide) -->
    <div id="universalModal" class="modal-overlay" onclick="closeModal('universalModal')">
        <div class="modal-box" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h2 class="modal-title">TITLE</h2>
            </div>
            <div class="modal-body">
                <!-- Content Injected via JS -->
            </div>
            <div class="modal-footer">
                <button class="action-btn" onclick="closeModal('universalModal')">Close</button>
            </div>
        </div>
    </div>

    <!-- 2. CALCULATOR MODAL (Kept separate for complex form handling) -->
    <div id="calcModal" class="modal-overlay" onclick="closeModal('calcModal')">
        <div class="modal-box modal-xl" onclick="event.stopPropagation()">
            <div class="calc-unit-header">
                <div style="display: flex; align-items: center; gap: 15px; flex-grow: 1;">
                    <img id="calcUnitImg" src="" class="calc-avatar">
                    <div class="calc-unit-details"><h2 id="calcUnitName" class="modal-title">Unit</h2><span id="calcUnitRole" class="calc-unit-role">Role</span></div>
                </div>
                <div class="calc-global-controls">
                    <!-- Controls injected/managed by JS -->
                    <div class="calc-stat-group" style="width: 150px;">
                        <label>Relic Set</label><select id="calcSet" class="c-input w-full" style="padding: 3px 6px;"></select>
                        <label class="mt-2">Trait</label><select id="calcTrait" class="c-input w-full" style="padding: 3px 6px;"></select>
                    </div>
                    <div class="calc-stat-group" style="width: 80px;">
                        <label>Dmg Pts</label><input type="number" id="calcDmgPoints" class="c-input text-center" value="0" min="0" max="100">
                        <label class="mt-2">Rank Dmg%</label><input type="number" id="calcRankDmg" class="c-input opt-gold text-center" value="20" min="0" max="20">
                    </div>
                    <div class="calc-stat-group" style="width: 80px;">
                        <label>Spa Pts</label><input type="number" id="calcSpaPoints" class="c-input text-center" value="0" min="0" max="100">
                        <label class="mt-2">Rank Spa%</label><input type="number" id="calcRankSpa" class="c-input opt-gold text-center" value="8" min="0" max="8">
                    </div>
                    <div class="calc-stat-group" style="width: 80px;">
                        <label>Rng Pts</label><input type="number" id="calcRangePoints" class="c-input text-center" value="0" min="0" max="100">
                        <label class="mt-2">Rank Rng%</label><input type="number" id="calcRankRange" class="c-input opt-gold text-center" value="20" min="0" max="20">
                    </div>
                </div>
            </div>
            <div class="modal-body calc-scroll-bg">
                <div class="gear-grid-container">
                    <!-- Gear Cards (Head/Body/Legs) - Contents managed by JS -->
                    <div class="gear-card">
                        <div class="gear-header"><span class="gear-title">Head Piece</span><div class="flex-1 flex-between gap-md items-end">
                            <select id="calcHead" class="gear-main-select"><option value="none">None</option><option value="sun_god">Sun God</option><option value="ninja">Ninja</option><option value="reaper_necklace">Reaper</option><option value="shadow_reaper_necklace">S. Reaper</option></select>
                            <select id="calcHeadStars" class="gear-main-select opt-gold w-65px hidden"><option value="1">1★</option><option value="1.025">2★</option><option value="1.05" selected>3★</option></select>
                        </div></div>
                        <div class="gear-subs">
                            <div class="sub-input-group"><span class="sub-label sub-dmg">Dmg</span><input type="number" data-stat="dmg" class="sub-val-input" placeholder="0"></div>
                            <div class="sub-input-group"><span class="sub-label sub-spa">Spa</span><input type="number" data-stat="spa" class="sub-val-input" placeholder="0"></div>
                            <div class="sub-input-group"><span class="sub-label sub-range">Rng</span><input type="number" data-stat="range" class="sub-val-input" placeholder="0"></div>
                            <div class="sub-input-group"><span class="sub-label sub-cm">CDmg</span><input type="number" data-stat="cm" class="sub-val-input" placeholder="0"></div>
                            <div class="sub-input-group"><span class="sub-label sub-cf">Crit</span><input type="number" data-stat="cf" class="sub-val-input" placeholder="0"></div>
                            <div class="sub-input-group"><span class="sub-label sub-dot">DoT</span><input type="number" data-stat="dot" class="sub-val-input" placeholder="0"></div>
                        </div>
                    </div>
                    <!-- Body & Legs Cards identical structure... -->
                    <div class="gear-card">
                        <div class="gear-header"><span class="gear-title">Body Main</span><div class="flex-1 flex-between gap-md items-end"><select id="calcBodyMain" class="gear-main-select"><option value="dmg">Damage</option><option value="dot">DoT</option><option value="cm">Crit Dmg</option></select><select id="calcBodyStars" class="gear-main-select opt-gold w-65px hidden"><option value="1.05">3★</option></select></div></div>
                        <div class="gear-subs"><div class="sub-input-group"><span class="sub-label sub-dmg">Dmg</span><input type="number" data-stat="dmg" class="sub-val-input"></div><div class="sub-input-group"><span class="sub-label sub-spa">Spa</span><input type="number" data-stat="spa" class="sub-val-input"></div><div class="sub-input-group"><span class="sub-label sub-range">Rng</span><input type="number" data-stat="range" class="sub-val-input"></div><div class="sub-input-group"><span class="sub-label sub-cm">CDmg</span><input type="number" data-stat="cm" class="sub-val-input"></div><div class="sub-input-group"><span class="sub-label sub-cf">Crit</span><input type="number" data-stat="cf" class="sub-val-input"></div><div class="sub-input-group"><span class="sub-label sub-dot">DoT</span><input type="number" data-stat="dot" class="sub-val-input"></div></div>
                    </div>
                    <div class="gear-card">
                        <div class="gear-header"><span class="gear-title">Legs Main</span><div class="flex-1 flex-between gap-md items-end"><select id="calcLegsMain" class="gear-main-select"><option value="dmg">Damage</option><option value="spa">SPA</option><option value="cf">Crit Rate</option><option value="range">Range</option></select><select id="calcLegsStars" class="gear-main-select opt-gold w-65px hidden"><option value="1.05">3★</option></select></div></div>
                        <div class="gear-subs"><div class="sub-input-group"><span class="sub-label sub-dmg">Dmg</span><input type="number" data-stat="dmg" class="sub-val-input"></div><div class="sub-input-group"><span class="sub-label sub-spa">Spa</span><input type="number" data-stat="spa" class="sub-val-input"></div><div class="sub-input-group"><span class="sub-label sub-range">Rng</span><input type="number" data-stat="range" class="sub-val-input"></div><div class="sub-input-group"><span class="sub-label sub-cm">CDmg</span><input type="number" data-stat="cm" class="sub-val-input"></div><div class="sub-input-group"><span class="sub-label sub-cf">Crit</span><input type="number" data-stat="cf" class="sub-val-input"></div><div class="sub-input-group"><span class="sub-label sub-dot">DoT</span><input type="number" data-stat="dot" class="sub-val-input"></div></div>
                    </div>
                </div>
                <div id="calcResultArea" class="calc-result-area hidden"><div id="calcResultContent"></div></div>
            </div>
            <div class="modal-footer">
                <button class="action-btn secondary btn-close-secondary" onclick="closeModal('calcModal')">Close</button>
                <button class="action-btn btn-calc-execute" onclick="runCustomCalc()">Calculate DPS</button>
            </div>
        </div>
    </div>

    <!-- 3. ADD RELIC MODAL -->
    <div id="addRelicModal" class="modal-overlay" onclick="closeModal('addRelicModal')">
        <div class="modal-box modal-sm" onclick="event.stopPropagation()">
            <div class="modal-header"><h2 class="modal-title">Add Relic</h2></div>
            <div class="modal-body">
                 <!-- Inputs for Add Relic -->
                 <div class="gear-grid-container" style="grid-template-columns: 1fr; padding: 0;">
                    <div class="gear-card">
                        <div class="gear-header">
                            <span class="gear-title">Relic Details</span>
                            <div class="flex-1 flex-between gap-md items-end">
                                <div style="display:flex; flex-direction:column; gap:5px; flex: 1;">
                                    <label class="mq-label">Slot</label>
                                    <select id="newRelicSlot" class="gear-main-select"><option value="Head">Head</option><option value="Body">Body</option><option value="Legs">Legs</option></select>
                                </div>
                                <div style="display:flex; flex-direction:column; gap:5px; flex: 1;">
                                    <label class="mq-label">Set</label>
                                    <select id="newRelicSet" class="gear-main-select"></select>
                                </div>
                                <div style="display:flex; flex-direction:column; width:80px; gap:5px;">
                                    <label class="mq-label">Stars</label>
                                    <select id="newRelicStars" class="gear-main-select opt-gold"></select>
                                </div>
                            </div>
                            <div style="display:flex; flex-direction:column; width:100%; gap:5px; margin-top:10px;">
                                <label class="mq-label">Main Stat</label>
                                <select id="newRelicMainStat" class="gear-main-select"></select>
                            </div>
                        </div>
                        <div class="gear-subs" style="margin-top:0; border-radius:0;">
                            <div class="sub-input-group"><span class="sub-label sub-dmg">Dmg</span><input type="number" id="subDmg" class="sub-val-input" placeholder="0"></div>
                            <div class="sub-input-group"><span class="sub-label sub-spa">Spa</span><input type="number" id="subSpa" class="sub-val-input" placeholder="0"></div>
                            <div class="sub-input-group"><span class="sub-label sub-range">Rng</span><input type="number" id="subRange" class="sub-val-input" placeholder="0"></div>
                            <div class="sub-input-group"><span class="sub-label sub-cm">CDmg</span><input type="number" id="subCdmg" class="sub-val-input" placeholder="0"></div>
                            <div class="sub-input-group"><span class="sub-label sub-cf">Crit</span><input type="number" id="subCrit" class="sub-val-input" placeholder="0"></div>
                            <div class="sub-input-group"><span class="sub-label sub-dot">DoT</span><input type="number" id="subDot" class="sub-val-input" placeholder="0"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button id="addRelicCancelBtn" class="action-btn secondary" onclick="closeModal('addRelicModal')">Cancel</button>
                <button id="addRelicConfirmBtn" class="action-btn">Add to Inventory</button>
            </div>
        </div>
    </div>

    <!-- 4. GUIDE CONFIG MODAL -->
    <div id="guideConfigModal" class="modal-overlay" onclick="closeModal('guideConfigModal')">
        <div class="modal-box modal-lg" onclick="event.stopPropagation()">
            <div class="modal-header"><h2 class="modal-title">Guide Configuration</h2></div>
            <div class="modal-body">
                <div class="config-section"><div class="config-header">1. Select Unit</div><div class="config-grid" id="guideConfigUnitGrid"></div></div>
                <div class="config-section mt-4"><div class="config-header">2. Select Trait</div><div class="config-chips" id="guideConfigTraitList"></div></div>
            </div>
            <div class="modal-footer">
                <button class="action-btn secondary" onclick="closeModal('guideConfigModal')">Cancel</button>
                <button class="action-btn" onclick="applyGuideConfig()">Apply Settings</button>
            </div>
        </div>
    </div>

    <!-- 5. CUSTOM PAIR MODAL -->
    <div id="customPairModal" class="modal-overlay" onclick="closeModal('customPairModal')">
        <div class="modal-box modal-lg" onclick="event.stopPropagation()">
            <div class="modal-header cp-header"><h2 class="modal-title">Create Custom Pair</h2></div>
            <div class="modal-body">
                <div class="config-section"><div class="config-header cp-section-header">1. Assign To Unit</div><div class="config-grid" id="cpUnitGrid"></div></div>
                <div class="config-section mt-4"><div class="config-header cp-section-header">2. Select First Trait</div><div class="config-chips" id="cpTrait1List"></div></div>
                <div class="config-section mt-4"><div class="config-header cp-section-header">3. Select Second Trait</div><div class="config-chips" id="cpTrait2List"></div></div>
                <div class="cp-preview-box"><span class="cp-preview-label">Creating Combination:</span><br><b class="cp-preview-val" id="cpPreviewText">Loading...</b></div>
            </div>
            <div class="modal-footer">
                <button class="action-btn secondary" onclick="closeModal('customPairModal')">Cancel</button>
                <button class="action-btn btn-cp-action" onclick="confirmAddCustomPair()">Create Pair</button>
            </div>
        </div>
    </div>

    <!-- 6. FEEDBACK MODAL -->
    <div id="feedbackModal" class="modal-overlay" onclick="closeModal('feedbackModal')">
        <div class="modal-box modal-sm" onclick="event.stopPropagation()">
            <div class="modal-header"><h2 class="modal-title">Feedback</h2></div>
            <div class="modal-body">
                <div class="feedback-form">
                    <label><span class="mq-label">Type</span>
                        <select id="feedbackType" class="gear-main-select mt-2"><option value="suggestion" selected>Suggestion</option><option value="bug">Bug Report</option></select>
                    </label>
                    <label><span class="mq-label">Message</span>
                        <textarea id="feedbackText" class="feedback-textarea" placeholder="Describe your suggestion or bug..."></textarea>
                    </label>
                    <div id="feedbackStatus"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="action-btn secondary" onclick="closeModal('feedbackModal')">Cancel</button>
                <button id="feedbackSendBtn" class="action-btn" onclick="sendFeedback()">Send</button>
            </div>
        </div>
    </div>

    <!-- SCRIPTS -->
    <script src="data.js"></script>
    <script src="math.js"></script>
    <script src="static-database.js"></script>
    <script src="modules/state.js"></script>
    <script src="modules/constants.js"></script>
    <script src="modules/utils.js"></script>
    <script src="modules/ui-helpers.js"></script>
    <script src="modules/calculations.js"></script>
    <script src="modules/rendering.js"></script>
    <script src="modules/modals.js"></script>
    <script src="modules/custom-pair.js"></script>
    <script src="modules/calculator.js"></script>
    <script src="modules/math-render.js"></script>
    <script src="modules/sub-priority.js"></script>
    <script src="modules/inventory.js"></script>
    <script src="modules/feedback.js"></script>
    <script src="modules/init.js"></script>

    <script>
        function toggleMobileMenu() {
            const toolbar = document.getElementById('headerToolbarSection');
            const fab = document.getElementById('mobileMenuFab');
            const isOpen = toolbar.classList.contains('is-mobile-open');

            if (isOpen) {
                toolbar.classList.remove('is-mobile-open');
                document.body.classList.remove('menu-open');
                fab.innerHTML = '<span>☰</span>';
                document.body.style.overflow = '';
                document.removeEventListener('click', closeMenuOnClickOutside);
            } else {
                toolbar.classList.add('is-mobile-open');
                document.body.classList.add('menu-open');
                fab.innerHTML = '<span>✕</span>';
                document.body.style.overflow = 'hidden';
                setTimeout(() => { document.addEventListener('click', closeMenuOnClickOutside); }, 100);
            }
        }
        function toggleMobileMenuIfOpen() {
            if (window.innerWidth <= 768) {
                const toolbar = document.getElementById('headerToolbarSection');
                if (toolbar.classList.contains('is-mobile-open')) toggleMobileMenu();
            }
        }
        function closeMenuOnClickOutside(e) {
            const toolbar = document.getElementById('headerToolbarSection');
            const fab = document.getElementById('mobileMenuFab');
            if (!toolbar.contains(e.target) && !fab.contains(e.target)) toggleMobileMenu();
        }
    </script>
</body>
</html>