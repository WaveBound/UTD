<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Universal TD Optimizer</title>
    
    <!-- CSS IMPORTS -->
    <link rel="stylesheet" href="css/variables.css">
    <link rel="stylesheet" href="css/base.css">
    <link rel="stylesheet" href="css/buttons.css">
    <link rel="stylesheet" href="css/cards.css">
    <link rel="stylesheet" href="css/forms.css">
    <link rel="stylesheet" href="css/modals.css">
    <link rel="stylesheet" href="css/utilities.css">
    <link rel="stylesheet" href="css/logic.css">
    <link rel="stylesheet" href="css/mobile.css">
</head>
<body>

    <!-- 1. HEADER TITLE SECTION -->
    <div id="headerTitleSection" class="header-wrapper">
        <div class="header-inner">
            <header id="mainHeader">
                <div id="headerContent">
                    <h1>Meta Optimizer</h1>
                </div>
            </header>
        </div>
    </div>

    <!-- 2. TOOLBAR SECTION (Desktop: Sticky Top | Mobile: Bottom Sheet) -->
    <div id="sticky-sentinel"></div>
    <div id="headerToolbarSection" class="sticky-toolbar-container">
        
        <!-- Mobile Drag Handle -->
        <div class="mobile-menu-handle" onclick="toggleMobileMenu()"></div>

        <!-- Navigation -->
        <div class="nav-bar">
            <button class="nav-btn active" onclick="switchPage('db'); toggleMobileMenuIfOpen()">Unit Database</button>
            <button class="nav-btn" onclick="switchPage('guides'); toggleMobileMenuIfOpen()">Build Guides</button>
            <button id="selectAllBtn" class="nav-btn" onclick="selectAllUnits()">Select All</button>
            
            <!-- COMPARE BUTTON -->
            <button id="compareBtn" class="nav-btn" onclick="openComparison(); toggleMobileMenuIfOpen()">Compare (<span id="compareCount">0</span>)</button>
            
            <!-- PATCH NOTES -->
            <button class="nav-btn" onclick="openPatchNotes(); toggleMobileMenuIfOpen()">Patch Notes</button>
        </div>

        <!-- 1. DATABASE TOOLBAR -->
        <div id="dbInjector" class="injector-panel">
            <button class="nav-btn add-btn" onclick="openCustomPairModal(); toggleMobileMenuIfOpen()">+ Add Custom Pair</button>
            
            <label id="hypoToggle" class="nav-toggle-label" title="Current: Relic Stats for DoT% are ignored (Bugged). Check to apply fixes.">
                <input type="checkbox" id="globalHypothetical" onchange="toggleHypothetical(this)">
                <span id="hypoLabel">Bugged Relics</span>
                <div class="mobile-switch-visual"></div>
            </label>

            <label id="headPieceToggle" class="nav-toggle-label is-checked" title="Auto-equips the best Unique Head Piece">
                <input type="checkbox" id="globalHeadPiece" onchange="toggleHeadPiece(this)" checked>
                <span>+ Head Relic</span>
                <div class="mobile-switch-visual"></div>
            </label>

            <label id="subStatsToggle" class="nav-toggle-label is-checked" title="Adds Perfect Sub-Stats to Calculations">
                <input type="checkbox" id="globalSubStats" onchange="toggleSubStats(this)" checked>
                <span>+ Sub Stats</span>
                <div class="mobile-switch-visual"></div>
            </label>
        </div>

        <!-- 2. GUIDES TOOLBAR -->
        <div id="guidesToolbar" class="injector-panel hidden">
            <select id="guideUnitSelect" class="hidden"><option value="all">All Units</option></select>
            <select id="guideTraitSelect" class="hidden"><option value="auto">Auto</option></select>

            <button class="nav-btn config-view-btn" onclick="openGuideConfig(); toggleMobileMenuIfOpen()">
            Configure View
            </button>

            <label id="guideHypoToggleWrapper" class="nav-toggle-label">
                <input type="checkbox" id="guideHypoToggle" onchange="toggleHypothetical(this)">
                <span id="guideHypoLabel">Bugged Relics</span>
                <div class="mobile-switch-visual"></div>
            </label>

            <label class="nav-toggle-label is-checked">
                <input type="checkbox" id="guideHeadPiece" onchange="toggleGuideHeadPiece(this)" checked>
                <span>+ Head Relic</span>
                <div class="mobile-switch-visual"></div>
            </label>

            <label class="nav-toggle-label is-checked">
                <input type="checkbox" id="guideSubStats" onchange="toggleGuideSubStats(this)" checked>
                <span>+ Sub Stats</span>
                <div class="mobile-switch-visual"></div>
            </label>
        </div>

        <!-- HEADER TOGGLE STRIP (Desktop Only) -->
        <div class="header-toggle-strip" onclick="toggleHeader()" title="Toggle Header">
            <button id="headerToggleBtn" class="header-toggle-btn">▲</button>
        </div>
    </div>

    <!-- Mobile Floating Action Button -->
    <button id="mobileMenuFab" class="mobile-fab" onclick="toggleMobileMenu()">
        <span>☰</span>
    </button>

    <!-- DATABASE PAGE -->
    <div id="dbPage" class="page active db-grid">
        <!-- Units injected via JS -->
    </div>

    <!-- GUIDES PAGE -->
    <div id="guidesPage" class="page">
        <div class="guide-container">
            <div id="activeGuideSelection" class="text-center mb-2 text-sm-dim">
                Showing: <b class="color-white" id="dispGuideUnit">All Units</b> with <b class="color-accent" id="dispGuideTrait">Auto Trait</b>
            </div>

            <div id="guideWarning" class="guide-warning">
                ⚠️ CURRENT BUG: Relic Stats for <b>DoT%</b> are currently ignored by the game. <br>
                Crit Rate% and Crit Dmg% are working effectively.
            </div>

            <div id="guideList" class="guide-grid">
                <!-- Cards injected via JS -->
            </div>
        </div>
    </div>

    <!-- MODALS -->

    <!-- Trait Guide Modal -->
    <div id="traitGuideModal" class="modal-overlay" onclick="closeTraitGuide()">
        <!-- Used new class modal-sm instead of inline style -->
        <div class="modal-content modal-sm" onclick="event.stopPropagation()">
            <div class="modal-header-fixed">
                <h2 class="text-lg uppercase">Recommended Traits</h2>
            </div>
            <div id="traitGuideContent" class="modal-scroll-area"></div>
            <div class="modal-footer-fixed"><button class="action-btn" onclick="closeTraitGuide()">Close</button></div>
        </div>
    </div>

    <!-- Guide Config -->
    <div id="guideConfigModal" class="modal-overlay" onclick="closeGuideConfig()">
        <!-- Used new class modal-lg instead of inline style -->
        <div class="modal-content modal-lg" onclick="event.stopPropagation()">
            <div class="modal-header-fixed">
                <h2 class="text-lg uppercase">Guide Configuration</h2>
            </div>
            <div class="modal-scroll-area">
                <div class="config-section">
                    <div class="config-header">1. Select Unit</div>
                    <div class="config-grid" id="guideConfigUnitGrid"></div>
                </div>
                <div class="config-section mt-4">
                    <div class="config-header">2. Select Trait</div>
                    <div class="config-chips" id="guideConfigTraitList"></div>
                </div>
            </div>
            <!-- Used utility classes flex-between, gap-md, justify-start -->
            <div class="modal-footer-fixed flex-between gap-md justify-start">
                <button class="action-btn secondary" onclick="closeGuideConfig()">Cancel</button>
                <button class="action-btn" onclick="applyGuideConfig()">Apply Settings</button>
            </div>
        </div>
    </div>

    <!-- Custom Pair -->
    <div id="customPairModal" class="modal-overlay" onclick="closeCustomPairModal()">
        <div class="modal-content modal-lg" onclick="event.stopPropagation()">
            <div class="modal-header-fixed cp-header">
                <h2 class="text-lg uppercase color-white">Create Custom Pair</h2>
            </div>
            <div class="modal-scroll-area">
                <div class="config-section">
                    <div class="config-header cp-section-header">1. Assign To Unit</div>
                    <div class="config-grid" id="cpUnitGrid"></div>
                </div>
                <div class="config-section mt-4">
                    <div class="config-header cp-section-header">2. Select First Trait</div>
                    <div class="config-chips" id="cpTrait1List"></div>
                </div>
                <div class="config-section mt-4">
                    <div class="config-header cp-section-header">3. Select Second Trait</div>
                    <div class="config-chips" id="cpTrait2List"></div>
                </div>
                <div class="cp-preview-box">
                    <span class="cp-preview-label">Creating Combination:</span><br>
                    <b class="cp-preview-val" id="cpPreviewText">Loading...</b>
                </div>
            </div>
            <div class="modal-footer-fixed flex-between gap-md justify-start">
                <button class="action-btn secondary" onclick="closeCustomPairModal()">Cancel</button>
                <button class="action-btn btn-cp-action" onclick="confirmAddCustomPair()">Create Pair</button>
            </div>
        </div>
    </div>

    <!-- Math Modal -->
    <div id="mathModal" class="modal-overlay" onclick="closeMath()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header-fixed">
                <h2 class="text-accent-start text-lg uppercase">DPS Breakdown</h2>
            </div>
            <div id="mathContent" class="modal-scroll-area"></div>
            <div class="modal-footer-fixed"><button class="action-btn" onclick="closeMath()">Close</button></div>
        </div>
    </div>

    <!-- Sub Stat Priority Modal -->
    <div id="subPriorityModal" class="modal-overlay" onclick="closeSubPriority()">
        <div class="modal-content modal-sm" onclick="event.stopPropagation()">
            <div class="modal-header-fixed">
                <h2 class="text-lg uppercase">Sub-Stat Priority</h2>
            </div>
            <div class="sub-prio-header">
                Comparing performance if you roll <strong>Perfect Stats</strong> of a specific type.
            </div>
            <div id="subPriorityContent" class="modal-scroll-area"></div>
            <div class="modal-footer-fixed"><button class="action-btn" onclick="closeSubPriority()">Close</button></div>
        </div>
    </div>

    <!-- Compare Modal -->
    <div id="compareModal" class="modal-overlay" onclick="closeCompare()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header-fixed">
                <h2 class="text-lg uppercase">Meta Comparison</h2>
            </div>
            <div id="compareContent" class="modal-scroll-area"></div>
            <div class="modal-footer-fixed"><button class="action-btn secondary" onclick="closeCompare()">Close</button></div>
        </div>
    </div>

    <!-- Patch Notes -->
    <div id="patchModal" class="modal-overlay" onclick="closePatchNotes()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header-fixed"><h2 class="text-lg uppercase">Patch Notes</h2></div>
            <div class="modal-scroll-area" id="patchNotesContainer"></div>
            <div class="modal-footer-fixed"><button class="action-btn" onclick="closePatchNotes()">Close</button></div>
        </div>
    </div>

    <!-- Custom Calculator Modal -->
    <div id="calcModal" class="modal-overlay" onclick="closeCalc()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="calc-unit-header">
                <img id="calcUnitImg" src="" class="calc-avatar"> 
                <div class="calc-unit-details">
                    <h2 id="calcUnitName" class="calc-unit-name">Unit Name</h2>
                    <span id="calcUnitRole" class="calc-unit-role">Role</span>
                </div>
                <div class="calc-global-controls">
                    <div class="c-control-group"><label>Dmg Pts</label><input type="number" id="calcDmgPoints" class="c-input" value="0" min="0" max="100"></div>
                    <div class="c-control-group"><label>Spa Pts</label><input type="number" id="calcSpaPoints" class="c-input" value="0" min="0" max="100"></div>
                    <div class="c-control-group flex-1.5"><label>Relic Set</label><select id="calcSet" class="c-input w-full"></select></div>
                    <div class="c-control-group flex-1"><label>Trait</label><select id="calcTrait" class="c-input w-full"></select></div>
                </div>
            </div>
            <div class="modal-scroll-area calc-scroll-bg">
                <div class="gear-grid-container">
                    <div class="gear-card">
                        <div class="gear-header">
                            <span class="gear-title">Head Piece</span>
                            <!-- Used utility classes: flex-1, flex-between, gap-md, items-end -->
                            <div class="flex-1 flex-between gap-md items-end">
                                <select id="calcHead" class="gear-main-select" style="border-color:#333; color:#aaa;">
                                    <option value="none">None / Standard</option>
                                    <option value="sun_god" class="opt-sungod">Sun God (+Range% Dmg)</option>
                                    <option value="ninja" class="opt-ninja">Master Ninja (+20% DoT)</option>
                                    <option value="reaper_necklace" class="opt-reaper">Reaper Necklace</option>
                                    <option value="shadow_reaper_necklace" class="opt-sreaper">Shadow Reaper Necklace</option>
                                </select>
                                <!-- Used utility classes: w-65px, hidden -->
                                <select id="calcHeadStars" class="gear-main-select opt-gold w-65px hidden">
                                    <option value="1">1★</option><option value="1.025">2★</option><option value="1.05" selected>3★</option>
                                </select>
                            </div>
                        </div>
                        <div class="gear-subs"><div class="sub-input-group"><span class="sub-label sub-dmg">Dmg</span><input type="number" data-stat="dmg" class="sub-val-input" placeholder="0"></div><div class="sub-input-group"><span class="sub-label sub-spa">Spa</span><input type="number" data-stat="spa" class="sub-val-input" placeholder="0"></div><div class="sub-input-group"><span class="sub-label sub-range">Rng</span><input type="number" data-stat="range" class="sub-val-input" placeholder="0"></div><div class="sub-input-group"><span class="sub-label sub-cm">CDmg</span><input type="number" data-stat="cm" class="sub-val-input" placeholder="0"></div><div class="sub-input-group"><span class="sub-label sub-cf">Crit</span><input type="number" data-stat="cf" class="sub-val-input" placeholder="0"></div><div class="sub-input-group"><span class="sub-label sub-dot">DoT</span><input type="number" data-stat="dot" class="sub-val-input" placeholder="0"></div></div>
                    </div>
                    <div class="gear-card">
                        <div class="gear-header">
                            <span class="gear-title">Body Main Stat</span>
                            <div class="flex-1 flex-between gap-md items-end">
                                <select id="calcBodyMain" class="gear-main-select">
                                    <option value="dmg">Damage +60%</option>
                                    <option value="dot">DoT +75%</option>
                                    <option value="cm">Crit Dmg +120%</option>
                                </select>
                                <select id="calcBodyStars" class="gear-main-select opt-gold w-65px hidden">
                                    <option value="1">1★</option><option value="1.025">2★</option><option value="1.05" selected>3★</option>
                                </select>
                            </div>
                        </div>
                        <div class="gear-subs"><div class="sub-input-group"><span class="sub-label sub-dmg">Dmg</span><input type="number" data-stat="dmg" class="sub-val-input" placeholder="0"></div><div class="sub-input-group"><span class="sub-label sub-spa">Spa</span><input type="number" data-stat="spa" class="sub-val-input" placeholder="0"></div><div class="sub-input-group"><span class="sub-label sub-range">Rng</span><input type="number" data-stat="range" class="sub-val-input" placeholder="0"></div><div class="sub-input-group"><span class="sub-label sub-cm">CDmg</span><input type="number" data-stat="cm" class="sub-val-input" placeholder="0"></div><div class="sub-input-group"><span class="sub-label sub-cf">Crit</span><input type="number" data-stat="cf" class="sub-val-input" placeholder="0"></div><div class="sub-input-group"><span class="sub-label sub-dot">DoT</span><input type="number" data-stat="dot" class="sub-val-input" placeholder="0"></div></div>
                    </div>
                    <div class="gear-card">
                        <div class="gear-header">
                            <span class="gear-title">Legs Main Stat</span>
                            <div class="flex-1 flex-between gap-md items-end">
                                <select id="calcLegsMain" class="gear-main-select">
                                    <option value="dmg">Damage +60%</option>
                                    <option value="spa">SPA -22.5%</option><option value="cf">Crit Rate +37.5%</option><option value="range">Range +30%</option>
                                </select>
                                <select id="calcLegsStars" class="gear-main-select opt-gold w-65px hidden">
                                    <option value="1">1★</option><option value="1.025">2★</option><option value="1.05" selected>3★</option>
                                </select>
                            </div>
                        </div>
                        <div class="gear-subs"><div class="sub-input-group"><span class="sub-label sub-dmg">Dmg</span><input type="number" data-stat="dmg" class="sub-val-input" placeholder="0"></div><div class="sub-input-group"><span class="sub-label sub-spa">Spa</span><input type="number" data-stat="spa" class="sub-val-input" placeholder="0"></div><div class="sub-input-group"><span class="sub-label sub-range">Rng</span><input type="number" data-stat="range" class="sub-val-input" placeholder="0"></div><div class="sub-input-group"><span class="sub-label sub-cm">CDmg</span><input type="number" data-stat="cm" class="sub-val-input" placeholder="0"></div><div class="sub-input-group"><span class="sub-label sub-cf">Crit</span><input type="number" data-stat="cf" class="sub-val-input" placeholder="0"></div><div class="sub-input-group"><span class="sub-label sub-dot">DoT</span><input type="number" data-stat="dot" class="sub-val-input" placeholder="0"></div></div>
                    </div>
                </div>
                <!-- Used hidden class instead of display:none -->
                <div id="calcResultArea" class="calc-result-area hidden">
                    <div id="calcResultContent"></div>
                </div>
            </div>
            <div class="calc-footer-bar">
                <button class="action-btn secondary btn-close-secondary" onclick="closeCalc()">Close</button>
                <button class="action-btn btn-calc-execute" onclick="runCustomCalc()">Calculate DPS</button>
            </div>
        </div>
    </div>

    <!-- Data & Math Engines -->
    <script src="data.js"></script>
    <script src="math.js"></script>
    <script src="static-database.js"></script>

    <!-- Modular Script Files -->
    <script src="modules/state.js"></script>
    <script src="modules/constants.js"></script>
    <script src="modules/utils.js"></script>
    <script src="modules/ui-helpers.js"></script>
    <script src="modules/calculations.js"></script>
    <script src="modules/rendering.js"></script>
    <script src="modules/modals.js"></script>
    <script src="modules/custom-pair.js"></script>
    <script src="modules/calculator.js"></script>
    <script src="modules/math-render.js"></script>
    <script src="modules/sub-priority.js"></script>
    <script src="modules/init.js"></script>

    <!-- INLINE SCRIPT FOR MOBILE MENU -->
    <script>
        function toggleMobileMenu() {
            const toolbar = document.getElementById('headerToolbarSection');
            const fab = document.getElementById('mobileMenuFab');
            const isOpen = toolbar.classList.contains('is-mobile-open');

            if (isOpen) {
                // CLOSING
                toolbar.classList.remove('is-mobile-open');
                document.body.classList.remove('menu-open');
                fab.innerHTML = '<span>☰</span>';
                document.body.style.overflow = '';
                document.removeEventListener('click', closeMenuOnClickOutside);
            } else {
                // OPENING
                toolbar.classList.add('is-mobile-open');
                document.body.classList.add('menu-open');
                fab.innerHTML = '<span>✕</span>';
                document.body.style.overflow = 'hidden';
                setTimeout(() => {
                    document.addEventListener('click', closeMenuOnClickOutside);
                }, 100);
            }
        }

        function toggleMobileMenuIfOpen() {
            if (window.innerWidth <= 768) {
                const toolbar = document.getElementById('headerToolbarSection');
                if (toolbar.classList.contains('is-mobile-open')) {
                    toggleMobileMenu();
                }
            }
        }

        function closeMenuOnClickOutside(e) {
            const toolbar = document.getElementById('headerToolbarSection');
            const fab = document.getElementById('mobileMenuFab');
            if (!toolbar.contains(e.target) && !fab.contains(e.target)) {
                toggleMobileMenu();
            }
        }
    </script>
</body>
</html>